# Small vision RL config for integration testing
# Minimal settings for fast CI runs

[algorithm]
type = "online"
method = "policy_gradient"
variety = "gspo"

[services]
task_url = "${TASK_APP_URL}"

[compute]
gpu_type = "H200"
gpu_count = 2

[topology]
type = "single_node_split"
gpus_for_vllm = 1
gpus_for_training = 1
gpus_for_ref = 0
tensor_parallel = 1

[vllm]
tensor_parallel_size = 1
max_model_len = 2048  # Smaller for faster testing
limit_mm_per_prompt = { "image": 1 }

[reference]
placement = "none"

[model]
base = "Qwen/Qwen3-VL-4B-Instruct"
trainer_mode = "lora"
label = "test-rl-vision-small"
supports_vision = true

[lora]
r = 8  # Smaller rank for faster testing
alpha = 16
dropout = 0.05
target_modules = ["q_proj", "v_proj"]  # Fewer targets

[rollout]
env_name = "crafter"
max_turns = 3  # Very short for CI
episodes_per_batch = 1  # Minimal
policy_name = "crafter-react"
max_concurrent_rollouts = 1
batches_per_step = 1  # Single batch
ops = ["agent", "env"]
task_app_origin_rewards_only = true

  [rollout.env_config]
  difficulty = "easy"
  
    [rollout.env_config.step_rewards]
    enabled = true
    mode = "decision_stepwise"
    strategy = "consistent"
    indicator_lambda = 1.0
    step_beta = 0.0

  [rollout.policy_config]
  use_vision = true
  image_only_mode = true
  temperature = 0.8
  top_p = 0.95
  max_tokens = 256  # Shorter for speed
  max_llm_calls = 3  # Very short episodes

[evaluation]
instances = 2  # Minimal for CI
every_n_iters = 1
seeds = [0, 1]

[training]
num_epochs = 1
iterations_per_epoch = 1  # Single iteration for CI
gradient_accumulation_steps = 1
max_accumulated_minibatch = 1
max_turns = 3
batch_size = 1
group_size = 1
learning_rate = 5e-5
log_interval = 1
weight_sync_interval = 1
event_rewards_kind = "unique"
async_semaphore_max = 1

step_rewards_enabled = true
step_rewards_mode = "decision_stepwise"
step_rewards_indicator_lambda = 1.0
step_rewards_beta = 0.0
step_rewards_strategy = "consistent"

max_images_per_message = 1
supports_vision = true

[training.weight_sync]
enable = true
targets = ["policy"]
mode = "direct"
direct = true
verify_every_k = 0

[judge]
type = "env"
timeout_s = 15  # Short timeout for CI

[tags]
experiment = "ci_test_rl_vision"
purpose = "integration_test"

