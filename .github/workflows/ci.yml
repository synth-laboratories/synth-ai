# CI workflow for pull requests and pushes to main branches.
# Runs lint, type check, tests, and validation checks in parallel.
# Keep jobs in alphabetical order.

name: CI

on:
  push:
    branches: [main, nightly]
  pull_request:

# Cancel in-progress runs on same branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  check-version:
    name: Check README Version
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4
      - name: Extract version from pyproject.toml
        id: get_version
        run: |
          VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/' | tr -d '"')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Found version: $VERSION"
          # Check if this is a dev version
          if [[ "$VERSION" == *".dev"* ]]; then
            echo "is_dev=true" >> $GITHUB_OUTPUT
          else
            echo "is_dev=false" >> $GITHUB_OUTPUT
          fi
      - name: Check README version matches
        if: steps.get_version.outputs.is_dev == 'false'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          README_BADGE=$(grep -o 'PyPI-.*-orange' README.md | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' || echo "")
          README_INSTALL=$(grep -o 'synth-ai==[0-9]\+\.[0-9]\+\.[0-9]\+' README.md | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' | head -1 || echo "")

          echo "pyproject.toml version: $VERSION"
          echo "README badge version: $README_BADGE"
          echo "README install version: $README_INSTALL"

          if [ "$README_BADGE" != "$VERSION" ]; then
            echo "❌ README badge version ($README_BADGE) does not match pyproject.toml ($VERSION)"
            exit 1
          fi

          if [ "$README_INSTALL" != "$VERSION" ]; then
            echo "❌ README install version ($README_INSTALL) does not match pyproject.toml ($VERSION)"
            exit 1
          fi

          echo "✅ README version matches pyproject.toml ($VERSION)"
      - name: Skip README check for dev versions
        if: steps.get_version.outputs.is_dev == 'true'
        run: |
          echo "⏭️ Skipping README version check for dev version: ${{ steps.get_version.outputs.version }}"

  integration-rlm:
    name: Integration (RLM v1)
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 10
    continue-on-error: true  # Don't block CI on backend issues
    env:
      DEV_ACTIONS_SYNTH_API_KEY: ${{ secrets.DEV_ACTIONS_SYNTH_API_KEY }}
      DEV_BACKEND_URL: ${{ secrets.DEV_BACKEND_URL }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: astral-sh/setup-uv@v4
      - name: Run RLM v1 integration tests
        run: |
          uv sync --group dev
          uv run --group dev pytest tests/integration/rlm -m integration -v --maxfail=1

  lint:
    name: Lint
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: astral-sh/setup-uv@v4
      - name: Run ruff check
        run: uv run --group dev ruff check

  notify-docs:
    name: Notify Docs
    runs-on: blacksmith-4vcpu-ubuntu-2404
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [lint, tests, type-check]
    steps:
      - name: Trigger docs SDK reference update
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.SYNTH_DOCS_REPO_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/synth-laboratories/docs/dispatches \
            -d '{"event_type": "sdk-updated"}'

  tests:
    name: Tests
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: astral-sh/setup-uv@v4
      - name: Run fast unit tests
        run: |
          uv sync --group dev
          uv run --group dev pytest tests/unit -m unit -v --maxfail=1

  type-check:
    name: Type Check
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: astral-sh/setup-uv@v4
      - name: Run ty check
        run: uv tool run ty check --respect-ignore-files --ignore invalid-return-type --ignore unresolved-attribute --ignore unresolved-import --ignore deprecated --ignore invalid-argument-type --ignore not-iterable --ignore unused-ignore-comment --ignore unknown-argument --ignore possibly-missing-attribute --ignore invalid-assignment

