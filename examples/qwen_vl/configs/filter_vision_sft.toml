# Filter vision traces for SFT training
# Applies quality filters and exports to SFT JSONL format

[filter]
input_db = "traces/gpt4omini_vision/rollouts.db"
output_dir = "traces/gpt4omini_vision/sft"

# Quality filters
min_steps_per_episode = 5        # Remove very short episodes
min_achievements_per_episode = 0  # Allow any achievement count (even 0)
max_steps_per_episode = 50        # Cap maximum length

# Behavioral filters
detect_loops = true               # Detect if agent got stuck
max_repeated_actions = 5          # Max same action in a row
min_unique_states = 3             # Require at least 3 unique states

# Remove episodes with errors
filter_errors = true
filter_timeouts = true

# Export format
export_format = "sft_jsonl"  # OpenAI-style messages format
include_images = true         # Keep base64 images in messages
include_metadata = true       # Keep episode/step metadata

# SFT-specific processing
[sft]
max_sequence_length = 2048    # Truncate messages if longer
deduplicate = true            # Remove duplicate state-action pairs
shuffle = true                # Shuffle samples for training

# Keep only high-quality tool calls
require_valid_tool_calls = true
filter_empty_responses = true

# Train/val split
[split]
enabled = true
val_fraction = 0.1
random_seed = 42
stratify_by = "achievements"  # Ensure val set has similar achievement distribution

# Output file names
train_file = "train.jsonl"
val_file = "val.jsonl"

# Statistics
[output]
save_stats = true
stats_file = "filter_stats.json"
save_filtered_episode_ids = true
